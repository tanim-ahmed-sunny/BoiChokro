<!-- Swap Interest Modal -->
<div class="modal fade" id="swapInterestModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Select Your Book to Swap</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p id="swapInstructionText" class="text-muted small mb-4">Choose one of your swap books to offer in exchange:</p>
                <div id="swapBooksContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="submitSwapRequestBtn" class="btn btn-success rounded-pill px-4" onclick="submitSwapRequest()" disabled>
                    Send Swap Request
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Load user's swap books when modal opens
document.getElementById('swapInterestModal')?.addEventListener('show.bs.modal', function() {
    loadUserSwapBooks();
});

function loadUserSwapBooks() {
    const container = document.getElementById('swapBooksContainer');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
    
    fetch('backend/actions/swap_actions.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'action=get_user_swap_books'
    })
    .then(res => res.json())
    .then(data => {
        const instruction = document.getElementById('swapInstructionText');
        const modalTitle = document.querySelector('#swapInterestModal .modal-title');
        
        if (data.success && data.books.length > 0) {
            instruction.classList.remove('d-none');
            modalTitle.textContent = 'Select Your Book to Swap';
            container.innerHTML = data.books.map(book => `
                <div class="swap-book-option p-3 border rounded-3 mb-2 cursor-pointer" style="cursor: pointer;" onclick="selectSwapBook(${book.id}, event)">
                    <div class="d-flex align-items-center gap-3">
                        <img src="${book.cover_image || 'https://via.placeholder.com/60x80?text=No+Image'}" class="rounded" width="60" height="80" style="object-fit: cover;" alt="${book.title}">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-bold">${book.title}</h6>
                            <p class="small text-muted mb-0">${book.author}</p>
                        </div>
                        <i class="bi bi-check-circle fs-4 text-success d-none check-icon"></i>
                    </div>
                </div>
            `).join('');
        } else {
            instruction.classList.add('d-none');
            modalTitle.textContent = 'Add Your Book for Swap';
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-book text-muted display-4 mb-3 d-block"></i>
                    <p class="text-muted mb-3">You haven't posted any books for swap yet.</p>
                    <a href="add_book.php" class="btn btn-primary rounded-pill px-4">Add Your Book for Swap</a>
                </div>
            `;
        }
    })
    .catch(err => {
        console.error(err);
        container.innerHTML = '<p class="text-danger text-center">Failed to load books</p>';
    });
}

let selectedSwapBookId = null;

function selectSwapBook(bookId, event) {
    selectedSwapBookId = bookId;
    
    document.querySelectorAll('.swap-book-option').forEach(el => {
        el.classList.remove('border-success', 'bg-light');
        el.querySelector('.check-icon')?.classList.add('d-none');
    });
    
    const selected = event.currentTarget;
    selected.classList.add('border-success', 'bg-light');
    selected.querySelector('.check-icon')?.classList.remove('d-none');
    
    document.getElementById('submitSwapRequestBtn').disabled = false;
}

function submitSwapRequest() {
    if (!selectedSwapBookId) {
        alert('Please select a book to offer');
        return;
    }
    
    const btn = document.getElementById('submitSwapRequestBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
    
    fetch('backend/actions/swap_actions.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `action=create_swap_request&requested_book_id=${currentBookId}&offered_book_id=${selectedSwapBookId}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('swapInterestModal')).hide();
            selectedSwapBookId = null;
        } else {
            alert(data.error || 'Failed to send request');
        }
        btn.disabled = false;
        btn.innerHTML = 'Send Swap Request';
    })
    .catch(err => {
        console.error(err);
        alert('Network error. Please try again.');
        btn.disabled = false;
        btn.innerHTML = 'Send Swap Request';
    });
}
</script>
